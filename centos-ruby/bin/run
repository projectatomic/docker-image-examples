#!/bin/bash -e

source /opt/ruby/etc/sdk

# The app_root_dir needs to be exported, so the Puma or other Ruby
# application server can pick it up and use it as 'application root'
#
export app_root_dir="${HOME}/src/${APP_ROOT:-.}"

export RACK_ENV=${RACK_ENV:-"production"}
export RAILS_ENV=${RAILS_ENV:-"${RACK_ENV}"}

cd $app_root_dir

# Allow users to inspect/debug the builder image itself, by using:
# $ docker run -i -t openshift/centos-ruby-builder --debug
#
# Allow rails users to directly attache rails console by using:
# $ docker run -i -t openshift/centos-ruby-builder --console

case $1 in
	"--debug") exec /bin/bash;;
	"--console")
		if is_rails_app; then
			exec /opt/ruby/bin/ruby_context bundle exec rails console ${RAILS_ENV}
		else
			exec /bin/bash;
		fi
		;;
esac

if is_puma_installed; then
  bundle_exec "puma --config ${HOME}/etc/puma.cfg"
else
  echo "You might consider adding 'puma' into your Gemfile."
  bundle_exec "rackup -P ${HOME}/run/rack.pid --host 0.0.0.0"
fi
